# Diagnose: Why Images Are Not Generating

Posts are generating but images are not appearing. This guide will help you identify and fix the issue.

## ðŸ” Most Likely Causes (Ranked by Probability)

### 1. âš ï¸ STABILITY_API_KEY Not Set in Vercel (90% likely)
**Symptom**: Posts generate fine, but no images
**Check**: Vercel Dashboard â†’ Settings â†’ Environment Variables
**Fix**: Add `STABILITY_API_KEY` with your Stability AI API key

### 2. âš ï¸ Image Generation Not Enabled in Schedule (80% likely)
**Symptom**: No image prompts being created
**Check**: Dashboard â†’ Schedule â†’ Image Generation toggle
**Fix**: Enable image generation and select specific time slots

---

## ðŸ“‹ Step-by-Step Diagnosis

### Step 1: Check Vercel Environment Variables

1. Go to [Vercel Dashboard](https://vercel.com/dashboard)
2. Select your Agent X project
3. Click **Settings** â†’ **Environment Variables**
4. Look for `STABILITY_API_KEY`

**Expected**: Should exist with value starting with `sk-`

**If Missing**:
```
Name: STABILITY_API_KEY
Value: [Your Stability AI API Key]
Environments: Production, Preview, Development
```

After adding, **redeploy** your application.

---

### Step 2: Check Schedule Configuration

Run this query in **Supabase SQL Editor**:

```sql
SELECT 
  user_id,
  image_generation_enabled,
  image_times,
  times as all_posting_times,
  timezone
FROM schedule_config
ORDER BY updated_at DESC;
```

**Expected Results**:
- `image_generation_enabled` = `true`
- `image_times` = Array with at least one time (e.g., `["09:00", "15:00"]`)
- `image_times` should match one or more times in `times` array

**If Not Configured**:
1. Go to Dashboard â†’ Schedule
2. Toggle "Enable Image Generation" to ON
3. Select which time slots should include images
4. Click Save

---

### Step 3: Check Recent Pipeline Logs

Run this query in **Supabase SQL Editor**:

```sql
SELECT 
  created_at,
  user_id,
  step,
  status,
  message,
  metadata
FROM pipeline_logs
WHERE message ILIKE '%image%'
ORDER BY created_at DESC
LIMIT 20;
```

**Look for these messages**:

âœ… **Good Signs**:
- `"Image generation: ENABLED for time XX:XX"`
- `"âœ“ Image prompt generated"`
- `"âœ“ Image generated by Stability AI!"`
- `"âœ“ Image uploaded! URL: ..."`

âŒ **Problem Indicators**:
- `"STABILITY_API_KEY not configured in environment variables"` â†’ Missing API key
- `"Image generation: DISABLED for time XX:XX"` â†’ Not enabled in schedule
- `"Image generation enabled but Claude did not create prompt"` â†’ Claude issue
- `"Stability AI generation failed: ..."` â†’ API key invalid or API error
- `"Image generated but upload failed: ..."` â†’ Supabase Storage issue

---

### Step 4: Check Recent Posts

Run this query in **Supabase SQL Editor**:

```sql
SELECT 
  created_at,
  user_id,
  platform,
  status,
  topic,
  image_url,
  CASE 
    WHEN image_data IS NOT NULL THEN 'Has image_data'
    ELSE 'No image_data'
  END as image_data_status,
  generation_metadata->>'image_generation_enabled' as img_gen_enabled,
  generation_metadata->>'has_image' as has_image,
  LEFT(generation_metadata->>'image_prompt', 100) as image_prompt_preview
FROM posts
ORDER BY created_at DESC
LIMIT 10;
```

**Expected for Posts with Images**:
- `image_url` = Public URL (e.g., `https://...supabase.co/storage/...`)
- `img_gen_enabled` = `"true"`
- `has_image` = `"true"`
- `image_prompt_preview` = Text starting with description

**If All NULL**:
- Image generation is not running at all
- Check Steps 1 & 2 above

---

### Step 5: Check Vercel Deployment Logs

1. Go to Vercel Dashboard â†’ Deployments
2. Click on the latest deployment
3. Click **Functions** tab
4. Look for `/api/workflows/run` or `/api/cron/publish`
5. Check the logs for image-related messages

**Search for**:
- `"[Workflow] Image generation REQUIRED"`
- `"[Workflow] STABILITY_API_KEY not configured"`
- `"[Workflow] âœ“ Image generated"`
- `"[Workflow] âœ“ Image uploaded"`

---

## ðŸ”§ Common Fixes

### Fix 1: Add STABILITY_API_KEY to Vercel

```bash
# In Vercel Dashboard:
# Settings â†’ Environment Variables â†’ Add New

Name: STABILITY_API_KEY
Value: [Your Stability AI API Key]
Environments: âœ“ Production âœ“ Preview âœ“ Development
```

**Then redeploy**:
- Go to Deployments tab
- Click â‹¯ on latest deployment
- Click "Redeploy"

---

### Fix 2: Enable Image Generation in Schedule

1. Go to **Dashboard** â†’ **Schedule**
2. Find the **"Image Generation"** section
3. Toggle **"Enable Image Generation"** to ON
4. Select time slots (e.g., check boxes for 09:00, 15:00)
5. Click **"Save Schedule"**

---

### Fix 3: Verify Claude API Key

If image prompts aren't being created:

```bash
# In Vercel Dashboard:
# Settings â†’ Environment Variables

# Verify CLAUDE_API_KEY exists and is correct:
CLAUDE_API_KEY=[Your Claude API Key]
```

---

### Fix 4: Check Supabase Storage Bucket

1. Go to Supabase Dashboard
2. Click **Storage** in sidebar
3. Look for `generated-images` bucket
4. Verify it exists and is public

**If Missing**, create it:
```sql
-- Run in Supabase SQL Editor
INSERT INTO storage.buckets (id, name, public)
VALUES ('generated-images', 'generated-images', true);
```

---

## ðŸ§ª Test Image Generation Manually

After applying fixes, test manually:

### Option 1: Trigger Workflow Endpoint

```bash
# Replace with your actual domain
curl -X POST https://your-domain.vercel.app/api/workflows/run
```

### Option 2: Wait for Next Scheduled Time

- Check your schedule configuration
- Wait for the next scheduled time slot with image generation enabled
- Monitor Vercel logs in real-time

---

## ðŸ“Š Expected Flow (When Working)

```
1. Cron triggers at scheduled time (e.g., 09:00)
   â†“
2. Workflow checks: shouldGenerateImageForTime() â†’ true
   â†“
3. Claude generates post content
   â†“
4. Claude generates detailed image prompt
   â†“
5. Stability AI generates image from prompt
   â†“
6. Image uploaded to Supabase Storage
   â†“
7. Public URL returned
   â†“
8. Post published to X/Telegram with image URL
   â†“
9. Image appears in post âœ…
```

---

## ðŸš¨ Error Messages & Solutions

### "STABILITY_API_KEY not configured in environment variables"
**Solution**: Add `STABILITY_API_KEY` to Vercel environment variables and redeploy

### "Image generation: DISABLED for time XX:XX"
**Solution**: Enable image generation in Schedule settings and select that time slot

### "Image generation enabled but Claude did not create prompt"
**Solution**: Check `CLAUDE_API_KEY` is set correctly in Vercel

### "Stability AI generation failed: Invalid API key"
**Solution**: Verify `STABILITY_API_KEY` value is correct (starts with `sk-`)

### "Image generated but upload failed"
**Solution**: Check Supabase Storage bucket `generated-images` exists and is public

### "Failed to publish to x: Media upload failed"
**Solution**: Image URL might be invalid or inaccessible. Check Supabase Storage permissions

---

## âœ… Verification Checklist

After applying fixes, verify:

- [ ] `STABILITY_API_KEY` exists in Vercel environment variables
- [ ] `CLAUDE_API_KEY` is updated to new key
- [ ] Application has been redeployed after adding keys
- [ ] Image generation is enabled in Schedule settings
- [ ] At least one time slot is selected for images
- [ ] `generated-images` bucket exists in Supabase Storage
- [ ] Recent pipeline logs show image generation attempts
- [ ] Recent posts have `image_url` populated
- [ ] Images appear in published posts on X/Telegram

---

## ðŸ“ž Still Not Working?

If images still aren't generating after all checks:

1. **Check Vercel Function Logs** for the exact error
2. **Run the diagnostic SQL queries** above
3. **Share the results** from:
   - Pipeline logs query (Step 3)
   - Recent posts query (Step 4)
   - Vercel function logs (Step 5)

This will help identify the exact point of failure in the pipeline.
