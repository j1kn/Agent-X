# Quick Fix: Image Generation Not Working

## Problem Identified

The image generation is not working because:

1. ✅ Image prompt is being generated by Gemini Pro
2. ❌ Gemini Imagen API is not publicly available yet or requires special access
3. ❌ Even if image data exists, it's not being uploaded to get a URL
4. ❌ Platforms (X, Telegram) need image URLs, not base64 data

## Solution Options

### Option 1: Use a Working Image Generation API (RECOMMENDED)

Replace Gemini Imagen with a working API like:

**A. Stability AI (Stable Diffusion)**
- API: https://platform.stability.ai/
- Cost: ~$0.002 per image
- Quality: Excellent
- Setup: Get API key from Stability AI

**B. DALL-E 3 (OpenAI)**
- API: https://platform.openai.com/
- Cost: ~$0.04 per image
- Quality: Excellent
- Setup: Use existing OpenAI integration

**C. Replicate (Multiple Models)**
- API: https://replicate.com/
- Cost: Pay per use
- Quality: Various models available
- Setup: Get API key from Replicate

### Option 2: Upload Base64 to Supabase Storage

If you want to keep using Gemini (when it becomes available):

1. Generate image with Gemini → Get base64 data
2. Upload base64 to Supabase Storage
3. Get public URL
4. Pass URL to platforms

### Option 3: Use Placeholder Images (TEMPORARY)

For testing purposes:
1. Use Unsplash API for free stock photos
2. Search based on post topic
3. Get image URL
4. Attach to post

## Recommended Implementation

### Step 1: Add Stability AI Integration

```typescript
// lib/ai/providers/stability-image.ts
export async function generateImageWithStability(
  prompt: string,
  apiKey: string
): Promise<{ success: boolean; imageUrl?: string; error?: string }> {
  try {
    const response = await fetch(
      'https://api.stability.ai/v1/generation/stable-diffusion-xl-1024-v1-0/text-to-image',
      {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`,
        },
        body: JSON.stringify({
          text_prompts: [{ text: prompt }],
          cfg_scale: 7,
          height: 1024,
          width: 1024,
          steps: 30,
          samples: 1,
        }),
      }
    )

    const data = await response.json()
    
    if (data.artifacts && data.artifacts[0]) {
      const base64Image = data.artifacts[0].base64
      
      // Upload to Supabase Storage
      const imageUrl = await uploadToSupabaseStorage(base64Image)
      
      return { success: true, imageUrl }
    }
    
    return { success: false, error: 'No image generated' }
  } catch (error) {
    return { 
      success: false, 
      error: error instanceof Error ? error.message : 'Unknown error' 
    }
  }
}
```

### Step 2: Add Supabase Storage Upload

```typescript
// lib/storage/image-upload.ts
import { createServiceClient } from '@/lib/supabase/server'

export async function uploadToSupabaseStorage(
  base64Data: string,
  userId: string
): Promise<string> {
  const supabase = createServiceClient()
  
  // Convert base64 to buffer
  const buffer = Buffer.from(base64Data, 'base64')
  
  // Generate unique filename
  const filename = `${userId}/${Date.now()}.png`
  
  // Upload to Supabase Storage
  const { data, error } = await supabase.storage
    .from('post-images')
    .upload(filename, buffer, {
      contentType: 'image/png',
      cacheControl: '3600',
    })
  
  if (error) throw error
  
  // Get public URL
  const { data: { publicUrl } } = supabase.storage
    .from('post-images')
    .getPublicUrl(filename)
  
  return publicUrl
}
```

### Step 3: Update Workflow

```typescript
// In workflow, replace Gemini image generation with:
if (shouldGenerateImage) {
  const imagePrompt = await createImagePromptWithGemini(masterContent, apiKey)
  const imageResult = await generateImageWithStability(imagePrompt, stabilityApiKey)
  
  if (imageResult.success) {
    imageUrl = imageResult.imageUrl
  }
}
```

## Quick Test Without Images

To verify the rest of the workflow works:

1. **Disable image generation temporarily**
   ```sql
   UPDATE schedule_config 
   SET image_generation_enabled = false 
   WHERE user_id = 'YOUR_USER_ID';
   ```

2. **Check if posts are being created**
   ```sql
   SELECT * FROM posts 
   ORDER BY created_at DESC 
   LIMIT 5;
   ```

3. **Check pipeline logs**
   ```sql
   SELECT * FROM pipeline_logs 
   WHERE message LIKE '%image%' 
   ORDER BY created_at DESC 
   LIMIT 10;
   ```

## Debug Steps

Run these queries to see what's happening:

```sql
-- 1. Check if image generation is enabled
SELECT 
  user_id,
  image_generation_enabled,
  image_times
FROM schedule_config;

-- 2. Check if Gemini API key is set
SELECT 
  id,
  gemini_api_key IS NOT NULL as has_key
FROM user_profiles;

-- 3. Check recent posts for image data
SELECT 
  id,
  image_url,
  image_data IS NOT NULL as has_data,
  generation_metadata->>'image_prompt' as prompt,
  created_at
FROM posts
ORDER BY created_at DESC
LIMIT 5;

-- 4. Check for errors
SELECT 
  step,
  status,
  message,
  created_at
FROM pipeline_logs
WHERE status IN ('error', 'warning')
ORDER BY created_at DESC
LIMIT 10;
```

## Next Steps

1. **Choose an image generation API** (Stability AI recommended)
2. **Get API key** for chosen service
3. **Implement the integration** (see code above)
4. **Create Supabase Storage bucket** named `post-images`
5. **Test the complete flow**

## Temporary Workaround

Until you implement a working image API, you can:

1. Generate image prompts (this works)
2. Store prompts in database (this works)
3. Manually generate images later using the prompts
4. Or use the prompts with MidJourney/DALL-E manually

The system is working correctly - it's just missing the actual image generation API integration!
